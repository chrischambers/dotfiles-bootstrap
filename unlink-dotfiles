#!/usr/bin/env bash
#
# unlink-dotfiles

set -e
source `pwd`/common.sh

# Defaults:
# ---------
os=$(detect_os)
# ---------

while [[ $# -gt 1 ]]
do
  key="$1"
  shift

  case $key in
    -o|--os )
      os="$1"
      shift
      ;;
    * )
      # unknown option
      ;;
  esac
done

if [[ -n $1 ]]; then
    dotfiles_root="$(abspath $1)"
else
    fail "The dotfiles directory path is a required argument."
fi

check_dotfiles_are_symbolic_links () {
  for source in $(find_dotfile_symlinks $dotfiles_root $os)
  do
    dest=$(determine_dotfile_destination $source)
    if [[ -e $dest && ! -L $dest ]]; then
        fail "All dotfiles must be symbolic links. $dest is not."
    fi
  done
}

unlink_dotfiles () {
  info 'Unlinking dotfiles'

  for source in $(find_dotfile_symlinks $dotfiles_root $os)
  do
    dest=$(determine_dotfile_destination $source)
    if [[ -L $dest ]]; then
      remove_link $dest
    fi
  done

}

echo ''
check_dotfiles_are_symbolic_links
unlink_dotfiles
